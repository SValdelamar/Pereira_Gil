{% extends 'base.html' %}
{% set title = 'Notificaciones' %}
{% block content %}
<style>
  .notificacion-item {
    transition: all 0.3s ease;
    border-left: 4px solid transparent;
  }
  .notificacion-item:hover {
    background: rgba(0, 184, 148, 0.05);
    transform: translateX(5px);
  }
  .notificacion-no-leida {
    background: rgba(45, 106, 79, 0.05);
    border-left-color: #2d6a4f;
  }
  .notificacion-leida {
    opacity: 0.8;
    border-left-color: #dee2e6;
  }
  .prioridad-alta {
    border-left-color: #dc3545 !important;
  }
  .prioridad-urgente {
    border-left-color: #dc3545 !important;
    background: rgba(220, 53, 69, 0.05) !important;
  }
  .badge-tipo {
    font-size: 0.75rem;
    padding: 0.35em 0.65em;
  }
</style>

<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-3">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}"><i class="bi bi-house-door"></i> Dashboard</a></li>
    <li class="breadcrumb-item active" aria-current="page">Notificaciones</li>
  </ol>
</nav>

<!-- Header -->
<div class="card border-0 shadow-sm mb-4" style="background: linear-gradient(135deg, #2d6a4f 0%, #40916c 100%);">
  <div class="card-body p-4">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
      <div>
        <h4 class="mb-1 text-white fw-bold">
          <i class="bi bi-bell me-2"></i>Notificaciones
          {% if total_no_leidas > 0 %}
            <span class="badge bg-danger ms-2">{{ total_no_leidas }}</span>
          {% endif %}
        </h4>
        <p class="mb-0 text-white opacity-90">Mantente informado sobre reservas y eventos del sistema</p>
      </div>
      {% if total_no_leidas > 0 %}
      <button class="btn btn-light" onclick="marcarTodasLeidas()" style="box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
        <i class="bi bi-check-all me-1"></i>Marcar todas como leídas
      </button>
      {% endif %}
    </div>
  </div>
</div>

<!-- Filtros -->
<div class="card border-0 shadow-sm mb-4">
  <div class="card-body">
    <div class="btn-group" role="group">
      <input type="radio" class="btn-check" name="filtro" id="filtro-todas" autocomplete="off" checked>
      <label class="btn btn-outline-primary" for="filtro-todas" onclick="filtrarNotificaciones('todas')">
        <i class="bi bi-inbox me-1"></i>Todas
      </label>
      
      <input type="radio" class="btn-check" name="filtro" id="filtro-no-leidas" autocomplete="off">
      <label class="btn btn-outline-primary" for="filtro-no-leidas" onclick="filtrarNotificaciones('no-leidas')">
        <i class="bi bi-envelope me-1"></i>No leídas
      </label>
      
      <input type="radio" class="btn-check" name="filtro" id="filtro-reservas" autocomplete="off">
      <label class="btn btn-outline-primary" for="filtro-reservas" onclick="filtrarNotificaciones('reservas')">
        <i class="bi bi-calendar-event me-1"></i>Reservas
      </label>
    </div>
  </div>
</div>

<!-- Lista de Notificaciones -->
<div class="card border-0 shadow-sm">
  <div class="card-body p-0">
    {% if notificaciones %}
      <div class="list-group list-group-flush" id="listaNotificaciones">
        {% for notif in notificaciones %}
        <div class="list-group-item notificacion-item {% if not notif.leida %}notificacion-no-leida{% else %}notificacion-leida{% endif %} 
                    {% if notif.prioridad == 'alta' %}prioridad-alta{% endif %}
                    {% if notif.prioridad == 'urgente' %}prioridad-urgente{% endif %}"
             data-id="{{ notif.id }}" 
             data-leida="{{ '1' if notif.leida else '0' }}"
             data-tipo="{{ notif.tipo }}">
          
          <div class="d-flex w-100 justify-content-between align-items-start">
            <div class="flex-grow-1">
              <div class="d-flex align-items-center mb-2">
                <!-- Icono según tipo -->
                {% if notif.tipo == 'reserva_nueva' %}
                  <i class="bi bi-calendar-plus text-primary me-2 fs-5"></i>
                {% elif notif.tipo == 'reserva_aprobada' %}
                  <i class="bi bi-check-circle text-success me-2 fs-5"></i>
                {% elif notif.tipo == 'reserva_rechazada' %}
                  <i class="bi bi-x-circle text-danger me-2 fs-5"></i>
                {% elif notif.tipo == 'mantenimiento' %}
                  <i class="bi bi-tools text-warning me-2 fs-5"></i>
                {% elif notif.tipo == 'inventario_bajo' %}
                  <i class="bi bi-exclamation-triangle text-danger me-2 fs-5"></i>
                {% else %}
                  <i class="bi bi-info-circle text-info me-2 fs-5"></i>
                {% endif %}
                
                <h6 class="mb-0 fw-bold">{{ notif.titulo }}</h6>
                
                {% if not notif.leida %}
                  <span class="badge bg-primary ms-2">Nueva</span>
                {% endif %}
                
                {% if notif.prioridad == 'alta' %}
                  <span class="badge bg-danger ms-1">Alta prioridad</span>
                {% elif notif.prioridad == 'urgente' %}
                  <span class="badge bg-danger ms-1">Urgente</span>
                {% endif %}
              </div>
              
              <p class="mb-2 text-muted">{{ notif.mensaje }}</p>
              
              <div class="d-flex align-items-center gap-3">
                <small class="text-muted">
                  <i class="bi bi-clock me-1"></i>{{ notif.fecha_creacion.strftime('%d/%m/%Y %H:%M') }}
                </small>
                
                {% if notif.remitente_nombre %}
                <small class="text-muted">
                  <i class="bi bi-person me-1"></i>{{ notif.remitente_nombre }}
                </small>
                {% endif %}
                
                <!-- Tipo de notificación -->
                <span class="badge badge-tipo {% if notif.tipo == 'reserva_nueva' %}bg-primary{% elif notif.tipo == 'reserva_aprobada' %}bg-success{% elif notif.tipo == 'reserva_rechazada' %}bg-danger{% else %}bg-secondary{% endif %}">
                  {{ notif.tipo.replace('_', ' ').title() }}
                </span>
              </div>
            </div>
            
            <div class="btn-group ms-3">
              {% if notif.accion_url %}
              <a href="{{ notif.accion_url }}" class="btn btn-sm btn-outline-primary" 
                 onclick="marcarComoLeida({{ notif.id }})">
                <i class="bi bi-arrow-right-circle"></i> Ver
              </a>
              {% endif %}
              
              {% if not notif.leida %}
              <button class="btn btn-sm btn-outline-secondary" 
                      onclick="marcarComoLeida({{ notif.id }})" 
                      title="Marcar como leída">
                <i class="bi bi-check"></i>
              </button>
              {% endif %}
              
              <button class="btn btn-sm btn-outline-danger" 
                      onclick="eliminarNotificacion({{ notif.id }})" 
                      title="Eliminar">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
          
          <!-- Para notificaciones de reserva pendiente (solo instructores a cargo de inventario) -->
          {% if notif.tipo == 'reserva_nueva' and session.get('user_level', 0) >= 5 and session.get('a_cargo_inventario', False) %}
          <div class="mt-3 pt-3 border-top">
            <div class="btn-group" role="group">
              <button class="btn btn-sm btn-success" onclick="responderReserva('{{ notif.referencia_id }}', 'aprobada')">
                <i class="bi bi-check-circle me-1"></i>Aprobar
              </button>
              <button class="btn btn-sm btn-danger" onclick="mostrarModalRechazo('{{ notif.referencia_id }}')">
                <i class="bi bi-x-circle me-1"></i>Rechazar
              </button>
            </div>
          </div>
          {% endif %}
        </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="text-center py-5">
        <i class="bi bi-bell-slash text-muted" style="font-size: 4rem;"></i>
        <p class="text-muted mt-3">No tienes notificaciones</p>
      </div>
    {% endif %}
  </div>
</div>

<!-- Modal para rechazar reserva -->
<div class="modal fade" id="modalRechazar" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Rechazar Reserva</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="motivoRechazo" class="form-label">Motivo del rechazo</label>
          <textarea class="form-control" id="motivoRechazo" rows="3" 
                    placeholder="Explica el motivo del rechazo..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-danger" onclick="confirmarRechazo()">
          <i class="bi bi-x-circle me-1"></i>Rechazar
        </button>
      </div>
    </div>
  </div>
</div>

<script>
let reservaIdTemporal = null;

function filtrarNotificaciones(filtro) {
  const items = document.querySelectorAll('.notificacion-item');
  items.forEach(item => {
    const leida = item.dataset.leida === '1';
    const tipo = item.dataset.tipo;
    
    if (filtro === 'todas') {
      item.style.display = '';
    } else if (filtro === 'no-leidas') {
      item.style.display = leida ? 'none' : '';
    } else if (filtro === 'reservas') {
      item.style.display = tipo.includes('reserva') ? '' : 'none';
    }
  });
}

function marcarComoLeida(notifId) {
  fetch(`/api/notificaciones/${notifId}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' }
  })
  .then(response => response.json())
  .then(data => {
    // Actualizar visualmente
    const item = document.querySelector(`[data-id="${notifId}"]`);
    if (item) {
      item.classList.remove('notificacion-no-leida');
      item.classList.add('notificacion-leida');
      item.dataset.leida = '1';
      const badge = item.querySelector('.badge.bg-primary');
      if (badge) badge.remove();
      
      // Actualizar contador
      actualizarContador();
    }
  })
  .catch(error => console.error('Error:', error));
}

function eliminarNotificacion(notifId) {
  if (!confirm('¿Estás seguro de eliminar esta notificación?')) return;
  
  fetch(`/api/notificaciones/${notifId}`, {
    method: 'DELETE',
    headers: { 'Content-Type': 'application/json' }
  })
  .then(response => response.json())
  .then(data => {
    const item = document.querySelector(`[data-id="${notifId}"]`);
    if (item) {
      item.style.transition = 'opacity 0.3s';
      item.style.opacity = '0';
      setTimeout(() => item.remove(), 300);
    }
    mostrarMensaje('Notificación eliminada', 'success');
    actualizarContador();
  })
  .catch(error => {
    console.error('Error:', error);
    mostrarMensaje('Error al eliminar notificación', 'danger');
  });
}

function marcarTodasLeidas() {
  // Implementar endpoint para marcar todas como leídas
  const noLeidas = document.querySelectorAll('.notificacion-no-leida');
  noLeidas.forEach(item => {
    marcarComoLeida(item.dataset.id);
  });
}

function mostrarModalRechazo(reservaId) {
  reservaIdTemporal = reservaId;
  const modal = new bootstrap.Modal(document.getElementById('modalRechazar'));
  modal.show();
}

function confirmarRechazo() {
  const motivo = document.getElementById('motivoRechazo').value.trim();
  if (!motivo) {
    alert('Debes especificar un motivo para el rechazo');
    return;
  }
  
  responderReserva(reservaIdTemporal, 'rechazada', motivo);
  bootstrap.Modal.getInstance(document.getElementById('modalRechazar')).hide();
}

function responderReserva(reservaId, respuesta, motivo = null) {
  fetch(`/api/reservas/${reservaId}/responder`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ 
      respuesta: respuesta,
      motivo_rechazo: motivo
    })
  })
  .then(response => response.json())
  .then(data => {
    mostrarMensaje(data.message, respuesta === 'aprobada' ? 'success' : 'warning');
    setTimeout(() => location.reload(), 1500);
  })
  .catch(error => {
    console.error('Error:', error);
    mostrarMensaje('Error al procesar la respuesta', 'danger');
  });
}

function actualizarContador() {
  const noLeidas = document.querySelectorAll('.notificacion-no-leida').length;
  const badge = document.querySelector('.badge.bg-danger');
  if (badge) {
    if (noLeidas > 0) {
      badge.textContent = noLeidas;
    } else {
      badge.remove();
    }
  }
}

function mostrarMensaje(mensaje, tipo) {
  // Implementar notificación tipo toast
  const alertDiv = document.createElement('div');
  alertDiv.className = `alert alert-${tipo} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
  alertDiv.style.zIndex = '9999';
  alertDiv.innerHTML = `
    ${mensaje}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  document.body.appendChild(alertDiv);
  
  setTimeout(() => alertDiv.remove(), 3000);
}
</script>
{% endblock %}
