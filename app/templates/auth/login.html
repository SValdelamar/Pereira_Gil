{% extends 'auth/base_auth.html' %}

{% block title %}Iniciar Sesión{% endblock %}

{% block extra_css %}
<link href="{{ url_for('static', filename='css/login.css') }}" rel="stylesheet">
{% endblock %}

{% block main_class %}{% endblock %}

{% block auth_content %}
    <div class="container-fluid">
        <div class="login-container">
            <div class="login-card">
                <div class="row g-0">
                    <!-- Lado Izquierdo - Branding -->
                    <div class="col-lg-6">
                        <div class="brand-side">
                            <div class="brand-logo">
                                <img src="https://www.sena.edu.co/Style%20Library/alayout/images/logoSena.png" 
                                     alt="Logo SENA" 
                                     style="width: 90px; height: auto;">
                            </div>
                            
                            <h1>Centro Minero SENA</h1>
                            <p>Sistema de Gestión de Laboratorios</p>
                            
                            <div class="feature-list">
                                <div class="feature-item">
                                    <i class="bi bi-camera-fill"></i>
                                    <div>
                                        <h6>Búsqueda Visual con IA</h6>
                                        <p>Encuentra equipos solo tomando una foto</p>
                                    </div>
                                </div>
                                
                                <div class="feature-item">
                                    <i class="bi bi-mic-fill"></i>
                                    <div>
                                        <h6>Comandos por Voz</h6>
                                        <p>Controla el sistema con tu voz</p>
                                    </div>
                                </div>
                                
                                <div class="feature-item">
                                    <i class="bi bi-person-badge"></i>
                                    <div>
                                        <h6>Reconocimiento Facial</h6>
                                        <p>Acceso rápido y seguro sin contraseñas</p>
                                    </div>
                                </div>
                                
                                <div class="feature-item">
                                    <i class="bi bi-robot"></i>
                                    <div>
                                        <h6>IA de Inventario</h6>
                                        <p>Gestión automatizada e inteligente</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Lado Derecho - Formulario -->
                    <div class="col-lg-6">
                        <div class="form-side">
                            <div class="form-header">
                                <h2>Iniciar Sesión</h2>
                                <p>Ingresa tus credenciales para continuar</p>
                            </div>
                            
                            <!-- Mensajes Flash -->
                            {% with messages = get_flashed_messages(with_categories=true) %}
                                {% if messages %}
                                    {% for category, message in messages %}
                                        <div class="alert alert-{{ 'danger' if category=='error' else category }} alert-dismissible fade show">
                                            {{ message }}
                                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                        </div>
                                    {% endfor %}
                                {% endif %}
                            {% endwith %}
                            
                            <!-- Formulario -->
                            <form method="POST" action="{{ url_for('login') }}">
                                <div class="mb-3">
                                    <label for="user_id" class="form-label">
                                        <i class="bi bi-person-badge me-2"></i>Usuario
                                    </label>
                                    <input type="text" class="form-control" id="user_id" name="user_id" 
                                           placeholder="Ej: INST001" required autofocus>
                                </div>

                                <div class="mb-4">
                                    <label for="password" class="form-label">
                                        <i class="bi bi-key me-2"></i>Contraseña
                                    </label>
                                    <input type="password" class="form-control" id="password" name="password" 
                                           placeholder="Ingresa tu contraseña" required>
                                </div>

                                <div class="row g-2 mb-3">
                                    <div class="col-9">
                                        <button type="submit" class="btn-login">
                                            <i class="bi bi-box-arrow-in-right me-2"></i>Iniciar Sesión
                                        </button>
                                    </div>
                                    <div class="col-3">
                                        <button type="button" class="btn-facial w-100" data-bs-toggle="modal" data-bs-target="#facialModal" title="Reconocimiento Facial">
                                            <i class="bi bi-camera-video"></i>
                                        </button>
                                    </div>
                                </div>

                                <div class="forgot-password">
                                    <a href="{{ url_for('recuperar_contrasena') }}">
                                        <i class="bi bi-question-circle me-1"></i>¿Olvidaste tu contraseña?
                                    </a>
                                </div>
                            </form>
                            
                            <div class="divider"></div>
                            
                            <div class="text-center">
                                <p class="mb-3" style="color: #64748b; font-size: 14px;">¿No tienes una cuenta?</p>
                                <a href="{{ url_for('registro') }}" class="btn-register">
                                    <i class="bi bi-person-plus me-2"></i>Crear Cuenta
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="text-center mt-4">
                <p style="color: rgba(255, 255, 255, 0.9); font-size: 14px;">
                    <i class="bi bi-c-circle me-1"></i>2025 Centro Minero SENA | Sistema v1.0
                </p>
                <p style="color: rgba(255, 255, 255, 0.7); font-size: 13px;">
                    Desarrollado por: Steven Valdelamar, Karen Quintero, Zharick Camargo
                </p>
            </div>
        </div>

<!-- Modal de Reconocimiento Facial -->
    <div class="modal fade" id="facialModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-camera-video me-2"></i>Reconocimiento Facial
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <video id="video" width="100%" height="300" autoplay></video>
                    <canvas id="canvas" style="display:none;"></canvas>
                    <div class="mt-3">
                        <button type="button" class="btn btn-success" id="captureBtn">
                            <i class="bi bi-camera me-2"></i>Capturar y Autenticar
                        </button>
                    </div>
                    <div id="facialStatus" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
        // Reconocimiento Facial
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const captureBtn = document.getElementById('captureBtn');
        const facialStatus = document.getElementById('facialStatus');
        const facialModal = document.getElementById('facialModal');

        // Activar cámara al abrir modal
        facialModal.addEventListener('shown.bs.modal', async function () {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
            } catch (error) {
                facialStatus.innerHTML = '<div class="alert alert-danger">Error al acceder a la cámara: ' + error.message + '</div>';
            }
        });

        // Detener cámara al cerrar modal
        facialModal.addEventListener('hidden.bs.modal', function () {
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
        });

        // Capturar y autenticar
        captureBtn.addEventListener('click', function () {
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0);
            
            const imageData = canvas.toDataURL('image/jpeg');
            
            facialStatus.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Procesando...</span></div>';

            fetch('/login_facial', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: imageData })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    facialStatus.innerHTML = '<div class="alert alert-success">✅ Autenticación exitosa. Redirigiendo...</div>';
                    setTimeout(() => {
                        window.location.href = data.redirect;
                    }, 1000);
                } else {
                    facialStatus.innerHTML = '<div class="alert alert-danger">❌ ' + data.message + '</div>';
                }
            })
            .catch(error => {
                facialStatus.innerHTML = '<div class="alert alert-danger">❌ Error de conexión: ' + error + '</div>';
            });
        });
</script>
{% endblock %}
