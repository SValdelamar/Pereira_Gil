{% extends 'base.html' %}
{% set title = 'Usuarios' %}
{% block content %}
<!-- Estilos compartidos ahora en modules.css -->

<!-- Header -->
<div class="card border-0 shadow-sm mb-4" style="background: linear-gradient(135deg, #2d6a4f 0%, #40916c 100%);">
  <div class="card-body p-4">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h4 class="mb-1 text-white fw-bold"><i class="bi bi-people me-2"></i>Gesti√≥n de Usuarios</h4>
        <p class="mb-0 text-white opacity-90">Administra los usuarios del sistema</p>
      </div>
      <button class="btn btn-light" data-bs-toggle="modal" data-bs-target="#modalNuevoUsuario">
        <i class="bi bi-person-plus me-1"></i>Nuevo Usuario
      </button>
    </div>
  </div>
</div>

<!-- Tabla de Usuarios -->
<div class="card border-0 shadow-sm">
  <div class="card-header border-0" style="background: linear-gradient(135deg, #2d6a4f 0%, #40916c 100%);">
    <h6 class="mb-0 text-white fw-bold"><i class="bi bi-list-ul me-2"></i>Lista de Usuarios</h6>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0" id="tablaUsuarios">
        <thead>
          <tr>
            <th>ID</th>
            <th><i class="bi bi-person me-1"></i>Nombre</th>
            <th><i class="bi bi-tag me-1"></i>Tipo</th>
            <th><i class="bi bi-book me-1"></i>Programa</th>
            <th><i class="bi bi-shield me-1"></i>Nivel</th>
            <th>Activo</th>
            <th><i class="bi bi-envelope me-1"></i>Email</th>
            <th><i class="bi bi-calendar me-1"></i>Registro</th>
            <th><i class="bi bi-camera me-1"></i>Rostro</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for u in usuarios %}
          <tr>
            <td class="text-muted small">{{ u.id }}</td>
            <td class="fw-semibold" style="color: #2d6a4f;">{{ u.nombre }}</td>
            <td><span class="badge rounded-pill" style="background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%);">{{ u.tipo }}</span></td>
            <td class="small">{{ u.programa }}</td>
            <td><span class="badge rounded-pill px-3" style="background: linear-gradient(135deg, #00b894 0%, #009b7d 100%);">{{ u.nivel_acceso }}</span></td>
            <td>
              {% if u.activo %}
              <span class="badge rounded-pill px-3" style="background: linear-gradient(135deg, #059669 0%, #047857 100%);">
                <i class="bi bi-check-circle me-1"></i>S√≠
              </span>
              {% else %}
              <span class="badge rounded-pill px-3" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);">
                <i class="bi bi-x-circle me-1"></i>No
              </span>
              {% endif %}
            </td>
            <td class="small text-muted">{{ u.email or '-' }}</td>
            <td class="small">{{ u.registro }}</td>
            <td>
              {% if u.tiene_rostro == 'S√≠' %}
              <span class="badge rounded-pill" style="background: linear-gradient(135deg, #059669 0%, #047857 100%);">
                <i class="bi bi-check-circle"></i>
              </span>
              {% else %}
              <span class="badge rounded-pill" style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);">
                <i class="bi bi-x-circle"></i>
              </span>
              {% endif %}
            </td>
            <td>
              <div class="btn-group btn-group-sm" role="group">
                <button class="btn btn-outline-primary" onclick="editarUsuario('{{ u.id }}', '{{ u.nombre }}', {{ u.nivel_acceso }}, {{ 1 if u.activo else 0 }})" title="Editar">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-outline-{{ 'danger' if u.activo else 'success' }}" onclick="toggleActivoUsuario('{{ u.id }}', {{ 0 if u.activo else 1 }})" title="{{ 'Desactivar' if u.activo else 'Activar' }}">
                  <i class="bi bi-{{ 'x-circle' if u.activo else 'check-circle' }}"></i>
                </button>
                <button class="btn btn-outline-danger" onclick="eliminarUsuario('{{ u.id }}', '{{ u.nombre }}')" title="Eliminar Permanentemente">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal Nuevo Usuario -->
<div class="modal fade" id="modalNuevoUsuario" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header" style="background: linear-gradient(135deg, #2d6a4f 0%, #40916c 100%);">
        <h5 class="modal-title text-white"><i class="bi bi-person-plus me-2"></i>Nuevo Usuario</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">ID Usuario *</label>
          <input type="text" class="form-control" id="nuevoId" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Nombre *</label>
          <input type="text" class="form-control" id="nuevoNombre" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Email</label>
          <input type="email" class="form-control" id="nuevoEmail">
        </div>
        <div class="mb-3">
          <label class="form-label">Nivel de Acceso *</label>
          <select class="form-select" id="nuevoNivel" required>
            <option value="1">1 - Aprendiz</option>
            <option value="2">2 - Funcionario</option>
            <option value="3">3 - Instructor (No Qu√≠mica)</option>
            <option value="4">4 - Instructor (Qu√≠mica)</option>
            <option value="5">5 - Instructor a cargo de Inventario</option>
            <option value="6">6 - Administrador</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Contrase√±a *</label>
          <input type="password" class="form-control" id="nuevoPassword" required>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-success" onclick="crearUsuario()">
          <i class="bi bi-check-circle me-1"></i>Crear Usuario
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Editar Usuario -->
<div class="modal fade" id="modalEditarUsuario" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header" style="background: linear-gradient(135deg, #2d6a4f 0%, #40916c 100%);">
        <h5 class="modal-title text-white"><i class="bi bi-pencil me-2"></i>Editar Usuario</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editId">
        <div class="mb-3">
          <label class="form-label">Nombre</label>
          <input type="text" class="form-control" id="editNombre" disabled>
        </div>
        <div class="mb-3">
          <label class="form-label">Nivel de Acceso *</label>
          <select class="form-select" id="editNivel" required>
            <option value="1">1 - Aprendiz</option>
            <option value="2">2 - Funcionario</option>
            <option value="3">3 - Instructor (No Qu√≠mica)</option>
            <option value="4">4 - Instructor (Qu√≠mica)</option>
            <option value="5">5 - Instructor a cargo de Inventario</option>
            <option value="6">6 - Administrador</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Nueva Contrase√±a (dejar vac√≠o para no cambiar)</label>
          <input type="password" class="form-control" id="editPassword">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" onclick="guardarEdicion()">
          <i class="bi bi-save me-1"></i>Guardar Cambios
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// Crear nuevo usuario
function crearUsuario() {
  const id = document.getElementById('nuevoId').value.trim();
  const nombre = document.getElementById('nuevoNombre').value.trim();
  const email = document.getElementById('nuevoEmail').value.trim();
  const nivel = document.getElementById('nuevoNivel').value;
  const password = document.getElementById('nuevoPassword').value;
  
  if (!id || !nombre || !nivel || !password) {
    alert('Por favor completa todos los campos obligatorios');
    return;
  }
  
  fetch('/api/usuarios/create', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      id: id,
      nombre: nombre,
      email: email,
      nivel_acceso: parseInt(nivel),
      password: password,
      tipo: 'usuario',
      activo: true
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      alert('Usuario creado exitosamente');
      location.reload();
    } else {
      alert('Error: ' + (data.message || 'No se pudo crear el usuario'));
    }
  })
  .catch(err => alert('Error: ' + err.message));
}

// Abrir modal de edici√≥n
function editarUsuario(id, nombre, nivel, activo) {
  document.getElementById('editId').value = id;
  document.getElementById('editNombre').value = nombre;
  document.getElementById('editNivel').value = nivel;
  document.getElementById('editPassword').value = '';
  
  const modal = new bootstrap.Modal(document.getElementById('modalEditarUsuario'));
  modal.show();
}

// Guardar edici√≥n
function guardarEdicion() {
  const id = document.getElementById('editId').value;
  const nivel = document.getElementById('editNivel').value;
  const password = document.getElementById('editPassword').value.trim();
  
  const data = {
    nivel_acceso: parseInt(nivel)
  };
  
  if (password) {
    data.password = password;
  }
  
  fetch(`/api/usuarios/${id}/update`, {
    method: 'PUT',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(data)
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      alert('Usuario actualizado exitosamente');
      location.reload();
    } else {
      alert('Error: ' + (data.message || 'No se pudo actualizar el usuario'));
    }
  })
  .catch(err => alert('Error: ' + err.message));
}

// Toggle activo/inactivo
function toggleActivoUsuario(id, nuevoEstado) {
  const accion = nuevoEstado == 1 ? 'activar' : 'desactivar';
  if (!confirm(`¬øEst√°s seguro de ${accion} este usuario?`)) return;
  
  fetch(`/api/usuarios/${id}/toggle`, {
    method: 'PUT',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ activo: nuevoEstado })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      alert(`Usuario ${accion === 'activar' ? 'activado' : 'desactivado'} exitosamente`);
      location.reload();
    } else {
      alert('Error: ' + (data.message || 'No se pudo cambiar el estado'));
    }
  })
  .catch(err => alert('Error: ' + err.message));
}

// Eliminar usuario permanentemente
function eliminarUsuario(id, nombre) {
  const mensaje = '‚ö†Ô∏è ADVERTENCIA: Eliminar permanentemente\n\n' +
                  'üë§ Usuario: ' + nombre + '\n' +
                  'üÜî ID: ' + id + '\n\n' +
                  '‚ùå Esta acci√≥n NO se puede deshacer\n' +
                  '‚ùå Se eliminar√°n todos sus datos\n\n' +
                  '¬øDeseas continuar?';
  
  if (!confirm(mensaje)) {
    return;
  }
  
  fetch(`/api/usuarios/${id}/delete`, {
    method: 'DELETE',
    headers: {'Content-Type': 'application/json'}
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      alert('‚úì Usuario eliminado permanentemente');
      location.reload();
    } else {
      alert('Error: ' + (data.message || 'No se pudo eliminar el usuario'));
    }
  })
  .catch(err => alert('Error: ' + err.message));
}
</script>
{% endblock %}
