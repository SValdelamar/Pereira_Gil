{% extends 'base.html' %}

{% block title %}Gestión de Creación de Cuentas{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="mb-1"><i class="bi bi-person-plus-fill me-2"></i>Gestión de Creación de Cuentas</h2>
      <p class="text-muted mb-0">Aprobar o rechazar solicitudes de registro de nuevos usuarios</p>
    </div>
    <div>
      {% if pendientes > 0 %}
      <span class="badge bg-warning text-dark fs-5">
        <i class="bi bi-clock-history me-1"></i>{{ pendientes }} pendiente{{ 's' if pendientes != 1 }}
      </span>
      {% else %}
      <span class="badge bg-success fs-5">
        <i class="bi bi-check-circle me-1"></i>Sin solicitudes pendientes
      </span>
      {% endif %}
    </div>
  </div>

  <!-- Filtros -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label fw-semibold">Filtrar por estado</label>
          <select class="form-select" id="filtroEstado">
            <option value="">Todos los estados</option>
            <option value="pendiente" selected>Pendientes</option>
            <option value="aprobada">Aprobadas</option>
            <option value="rechazada">Rechazadas</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label fw-semibold">Buscar usuario</label>
          <input type="text" class="form-control" id="buscarUsuario" placeholder="Nombre o ID...">
        </div>
        <div class="col-md-4">
          <label class="form-label fw-semibold">Nivel solicitado</label>
          <select class="form-select" id="filtroNivel">
            <option value="">Todos los niveles</option>
            <option value="2">Funcionario</option>
            <option value="3">Instructor (No Química)</option>
            <option value="4">Instructor (Química)</option>
            <option value="5">Instructor Inventario</option>
            <option value="6">Administrador</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabla de solicitudes -->
  <div class="card shadow-sm">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>Listado de Solicitudes</h5>
    </div>
    <div class="card-body p-0">
      {% if solicitudes %}
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>ID</th>
              <th>Usuario</th>
              <th>Email</th>
              <th>Nivel Actual</th>
              <th>Nivel Solicitado</th>
              <th>Fecha Solicitud</th>
              <th>Estado</th>
              <th class="text-center">Acciones</th>
            </tr>
          </thead>
          <tbody id="tablaSolicitudes">
            {% for sol in solicitudes %}
            <tr class="solicitud-row" 
                data-estado="{{ sol.estado }}" 
                data-nivel="{{ sol.nivel_solicitado }}"
                data-usuario="{{ sol.nombre|lower }} {{ sol.usuario_id|lower }}">
              
              <td class="fw-semibold">#{{ sol.id }}</td>
              
              <td>
                <div>
                  <strong>{{ sol.nombre }}</strong>
                  <br>
                  <small class="text-muted">ID: {{ sol.usuario_id }}</small>
                </div>
              </td>
              
              <td>
                <small>{{ sol.email }}</small>
              </td>
              
              <td>
                <span class="badge bg-secondary">
                  Nivel {{ sol.nivel_actual }} - {{ roles_nombres[sol.nivel_actual] }}
                </span>
              </td>
              
              <td>
                <span class="badge" style="background: {% if sol.nivel_solicitado == 6 %}#dc3545{% elif sol.nivel_solicitado >= 4 %}#fd7e14{% else %}#0d6efd{% endif %}">
                  <i class="bi bi-arrow-up-circle me-1"></i>
                  Nivel {{ sol.nivel_solicitado }} - {{ roles_nombres[sol.nivel_solicitado] }}
                </span>
              </td>
              
              <td>
                <small>{{ sol.fecha_solicitud.strftime('%d/%m/%Y %H:%M') if sol.fecha_solicitud else 'N/A' }}</small>
              </td>
              
              <td>
                {% if sol.estado == 'pendiente' %}
                  <span class="badge bg-warning text-dark">
                    <i class="bi bi-clock-history me-1"></i>Pendiente
                  </span>
                {% elif sol.estado == 'aprobada' %}
                  <span class="badge bg-success">
                    <i class="bi bi-check-circle me-1"></i>Aprobada
                  </span>
                  {% if sol.fecha_respuesta %}
                  <br><small class="text-muted">{{ sol.fecha_respuesta.strftime('%d/%m/%Y') }}</small>
                  {% endif %}
                {% else %}
                  <span class="badge bg-danger">
                    <i class="bi bi-x-circle me-1"></i>Rechazada
                  </span>
                  {% if sol.fecha_respuesta %}
                  <br><small class="text-muted">{{ sol.fecha_respuesta.strftime('%d/%m/%Y') }}</small>
                  {% endif %}
                {% endif %}
              </td>
              
              <td class="text-center">
                {% if sol.estado == 'pendiente' %}
                  <!-- Botón Aprobar -->
                  <button class="btn btn-sm btn-success me-1" 
                          data-bs-toggle="modal" 
                          data-bs-target="#modalAprobar"
                          onclick="setearSolicitud({{ sol.id }}, '{{ sol.usuario_id }}', '{{ sol.nombre }}', {{ sol.nivel_solicitado }}, '{{ roles_nombres[sol.nivel_solicitado] }}')">
                    <i class="bi bi-check-circle"></i>
                  </button>
                  
                  <!-- Botón Rechazar -->
                  <button class="btn btn-sm btn-danger" 
                          data-bs-toggle="modal" 
                          data-bs-target="#modalRechazar"
                          onclick="setearSolicitud({{ sol.id }}, '{{ sol.usuario_id }}', '{{ sol.nombre }}', {{ sol.nivel_solicitado }}, '{{ roles_nombres[sol.nivel_solicitado] }}')">
                    <i class="bi bi-x-circle"></i>
                  </button>
                {% else %}
                  <!-- Ver detalles -->
                  <button class="btn btn-sm btn-outline-secondary" 
                          data-bs-toggle="modal" 
                          data-bs-target="#modalDetalles"
                          onclick="mostrarDetalles('{{ sol.usuario_id }}', '{{ sol.nombre }}', {{ sol.nivel_actual }}, {{ sol.nivel_solicitado }}, '{{ sol.estado }}', '{{ sol.admin_revisor or "N/A" }}', '{{ sol.comentario_admin or "" }}')">
                    <i class="bi bi-eye"></i>
                  </button>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="text-center py-5">
        <i class="bi bi-inbox display-1 text-muted"></i>
        <h4 class="text-muted mt-3">No hay solicitudes registradas</h4>
        <p class="text-muted">Las solicitudes de cambio de nivel aparecerán aquí</p>
      </div>
      {% endif %}
    </div>
  </div>

</div>

<!-- Modal Aprobar -->
<div class="modal fade" id="modalAprobar" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title"><i class="bi bi-check-circle me-2"></i>Aprobar Solicitud</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form method="POST" id="formAprobar">
        <div class="modal-body">
          <div class="alert alert-success">
            <i class="bi bi-info-circle me-2"></i>
            <strong>¿Estás seguro de aprobar esta solicitud?</strong>
          </div>
          
          <dl class="row mb-3">
            <dt class="col-sm-4">Usuario:</dt>
            <dd class="col-sm-8"><strong id="aprobar-usuario"></strong></dd>
            
            <dt class="col-sm-4">ID:</dt>
            <dd class="col-sm-8"><span id="aprobar-id"></span></dd>
            
            <dt class="col-sm-4">Nuevo nivel:</dt>
            <dd class="col-sm-8">
              <span class="badge bg-success" id="aprobar-nivel"></span>
            </dd>
          </dl>
          
          <div class="mb-3">
            <label class="form-label">Comentario (opcional)</label>
            <textarea class="form-control" name="comentario" rows="3" placeholder="Agrega un comentario sobre esta aprobación..."></textarea>
          </div>
          
          <div class="alert alert-warning mb-0">
            <small><i class="bi bi-exclamation-triangle me-1"></i>El usuario obtendrá los permisos del nuevo nivel inmediatamente.</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-success">
            <i class="bi bi-check-circle me-1"></i>Aprobar Solicitud
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Rechazar -->
<div class="modal fade" id="modalRechazar" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title"><i class="bi bi-x-circle me-2"></i>Rechazar Solicitud</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form method="POST" id="formRechazar">
        <div class="modal-body">
          <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>¿Estás seguro de rechazar esta solicitud?</strong>
          </div>
          
          <dl class="row mb-3">
            <dt class="col-sm-4">Usuario:</dt>
            <dd class="col-sm-8"><strong id="rechazar-usuario"></strong></dd>
            
            <dt class="col-sm-4">ID:</dt>
            <dd class="col-sm-8"><span id="rechazar-id"></span></dd>
            
            <dt class="col-sm-4">Nivel solicitado:</dt>
            <dd class="col-sm-8">
              <span class="badge bg-danger" id="rechazar-nivel"></span>
            </dd>
          </dl>
          
          <div class="mb-3">
            <label class="form-label">Motivo del rechazo <span class="text-danger">*</span></label>
            <textarea class="form-control" name="comentario" rows="3" placeholder="Explica por qué se rechaza esta solicitud..." required></textarea>
          </div>
          
          <div class="alert alert-info mb-0">
            <small><i class="bi bi-info-circle me-1"></i>El usuario mantendrá su nivel actual.</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-danger">
            <i class="bi bi-x-circle me-1"></i>Rechazar Solicitud
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Detalles -->
<div class="modal fade" id="modalDetalles" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-info-circle me-2"></i>Detalles de la Solicitud</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <dl class="row">
          <dt class="col-sm-4">Usuario:</dt>
          <dd class="col-sm-8"><strong id="detalle-usuario"></strong></dd>
          
          <dt class="col-sm-4">ID:</dt>
          <dd class="col-sm-8"><span id="detalle-id"></span></dd>
          
          <dt class="col-sm-4">Nivel actual:</dt>
          <dd class="col-sm-8"><span id="detalle-nivel-actual"></span></dd>
          
          <dt class="col-sm-4">Nivel solicitado:</dt>
          <dd class="col-sm-8"><span id="detalle-nivel-solicitado"></span></dd>
          
          <dt class="col-sm-4">Estado:</dt>
          <dd class="col-sm-8"><span id="detalle-estado"></span></dd>
          
          <dt class="col-sm-4">Revisado por:</dt>
          <dd class="col-sm-8"><span id="detalle-admin"></span></dd>
          
          <dt class="col-sm-4">Comentario:</dt>
          <dd class="col-sm-8"><span id="detalle-comentario" class="text-muted"></span></dd>
        </dl>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<script>
// Variables globales
let solicitudActual = null;

// Setear datos de solicitud en modales
function setearSolicitud(id, usuarioId, nombre, nivel, nombreNivel) {
  solicitudActual = id;
  
  // Modal aprobar
  document.getElementById('aprobar-usuario').textContent = nombre;
  document.getElementById('aprobar-id').textContent = usuarioId;
  document.getElementById('aprobar-nivel').textContent = `Nivel ${nivel} - ${nombreNivel}`;
  document.getElementById('formAprobar').action = `/admin/solicitud/aprobar/${id}`;
  
  // Modal rechazar
  document.getElementById('rechazar-usuario').textContent = nombre;
  document.getElementById('rechazar-id').textContent = usuarioId;
  document.getElementById('rechazar-nivel').textContent = `Nivel ${nivel} - ${nombreNivel}`;
  document.getElementById('formRechazar').action = `/admin/solicitud/rechazar/${id}`;
}

// Mostrar detalles de solicitud procesada
function mostrarDetalles(usuarioId, nombre, nivelActual, nivelSolicitado, estado, admin, comentario) {
  document.getElementById('detalle-usuario').textContent = nombre;
  document.getElementById('detalle-id').textContent = usuarioId;
  document.getElementById('detalle-nivel-actual').textContent = `Nivel ${nivelActual}`;
  document.getElementById('detalle-nivel-solicitado').textContent = `Nivel ${nivelSolicitado}`;
  
  const estadoBadge = estado === 'aprobada' 
    ? '<span class="badge bg-success">Aprobada</span>' 
    : '<span class="badge bg-danger">Rechazada</span>';
  document.getElementById('detalle-estado').innerHTML = estadoBadge;
  
  document.getElementById('detalle-admin').textContent = admin;
  document.getElementById('detalle-comentario').textContent = comentario || 'Sin comentarios';
}

// Filtros
document.addEventListener('DOMContentLoaded', function() {
  const filtroEstado = document.getElementById('filtroEstado');
  const buscarUsuario = document.getElementById('buscarUsuario');
  const filtroNivel = document.getElementById('filtroNivel');
  const filas = document.querySelectorAll('.solicitud-row');
  
  function aplicarFiltros() {
    const estadoSeleccionado = filtroEstado.value.toLowerCase();
    const busqueda = buscarUsuario.value.toLowerCase();
    const nivelSeleccionado = filtroNivel.value;
    
    filas.forEach(fila => {
      const estado = fila.dataset.estado.toLowerCase();
      const usuario = fila.dataset.usuario.toLowerCase();
      const nivel = fila.dataset.nivel;
      
      const matchEstado = !estadoSeleccionado || estado === estadoSeleccionado;
      const matchUsuario = !busqueda || usuario.includes(busqueda);
      const matchNivel = !nivelSeleccionado || nivel === nivelSeleccionado;
      
      if (matchEstado && matchUsuario && matchNivel) {
        fila.style.display = '';
      } else {
        fila.style.display = 'none';
      }
    });
  }
  
  filtroEstado.addEventListener('change', aplicarFiltros);
  buscarUsuario.addEventListener('input', aplicarFiltros);
  filtroNivel.addEventListener('change', aplicarFiltros);
  
  // Aplicar filtro inicial (mostrar solo pendientes)
  aplicarFiltros();
});
</script>

{% endblock %}
